<link rel="import" href="../../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../../bower_components/core-drawer-panel/core-drawer-panel.html">
<link rel="import" href="../../bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/core-item/core-item.html">
<link rel="import" href="../../bower_components/core-icons/iconsets/social-icons.html">
<link rel="import" href="../../bower_components/core-icons/iconsets/maps-icons.html">
<link rel="import" href="../../bower_components/core-icons/iconsets/image-icons.html">

<link rel="import" href="../services/fd-rest-element-service.html">
<link rel="import" href="fd-menu.html">

<link rel="import" href="../plug-list.html">
<link rel="import" href="../obj-list.html">

<polymer-element name="fd-layout" attributes="responsiveWidth">
<template>

  <link rel="stylesheet" href="fd-layout.css">

  <core-drawer-panel id="drawerPanel" narrow="{{narrow}}" responsiveWidth="{{responsiveWidth}}">
    
    
    <core-header-panel drawer >
      <core-toolbar class="{{ {'medium-tall' : !narrow} | tokenList }}">
       <img class="bottom fit" src="../../images/freedomotic_white.svg">
      </core-toolbar>
      
      <fd-menu id="menu" on-core-select="{{menuSelect}}"></fd-menu>
    </core-header-panel>
    
    <core-header-panel id="mainHeaderPanel" main mode="{{narrow ? 'waterfall' : 'cover'}}">
      <core-toolbar class="{{ {'medium-tall' : !narrow} | tokenList }}">
        <content select=".menuButton" on-tap="{{togglePanel}}">
          <paper-icon-button class="menuButton fallback" icon="menu"></core-icon-button>
        </content>
        <div hidden?="{{!narrow}}">{{item.label}}</div>
      </core-toolbar>
      
      <div id="card" on-transitionend="{{cardTransitionDone}}" hidden?="{{!item}}">
        <div class="element-label" hidden?="{{narrow}}">{{item.label}}</div>
        <core-selector id="frame" class="container" layout vertical center>
          <!--<plug-list show="all"></plug-list>-->
        </core-selector>
      </div>
        
    </core-header-panel>
  </core-drawer-panel>

</template>
<script>

   Polymer('fd-layout', {
    
    selected: 0,
    
    
    responsiveWidth: '860px',
    
    ready:function(){
      window.addEventListener('resize', this.updateFrameHeight.bind(this));
    },
    
    created: function(){
      this.frameElement = document.createElement('div');
      //this.fdplugins = document.getElementById("pluginsService");
      //this.fdobjects = document.getElementById("objectsService");
      
    },
     attached: function() {
       this.$.frame.appendChild(this.frameElement);
       //this.updateMenu();
     },
    
     menuSelect: function(e, detail) {
      if (detail.isSelected) {
        this.item = detail.item;
        if (this.item.children.length) {
          this.item.selected = 0;
        }
        this.item.tag = this.item.getAttribute('tag');
        //var type = this.item.getAttribute('type');
        //TODO: avoid always creating elements.
        var el = document.createElement(this.item.tag);
        
        this.$.frame.removeChild(this.frameElement);
        this.frameElement = el;
        this.$.frame.appendChild(this.frameElement);
        if (this.narrow) {
          this.$.drawerPanel.closeDrawer();
        } else{
        this.animateCard();
        }
      }
    },
    
   animateCard: function() {
      this.$.card.classList.remove('move-up');
      this.$.card.style.display = 'none';
      this.async(function() {
        this.$.card.style.display = 'block';
        this.moveCard(this.$.mainHeaderPanel.offsetHeight);
        this.async(function() {
          this.$.card.classList.add('move-up');
          this.moveCard(null);
        }, null, 300);
      });
    },
    
    moveCard: function(y) {
      var s = this.$.card.style;
      s.webkitTransform = s.transform = 
          y ? 'translate3d(0, ' + y + 'px,0)' : '';
    },
    
    cardTransitionDone: function() {
      if (this.$.card.classList.contains('move-up')) {
        this.$.card.classList.remove('move-up');
        //this.updateFrameHeight();
      }
    },
    
    togglePanel: function() {
      this.$.drawerPanel.togglePanel();
    },
    
    resizeFrame: function() {
      this.job('resizeFrame', function() {
        this.updateFrameHeight();
      });
    },
    
    updateFrameHeight: function() {
      var frame = this.$.frame;
      var doc = frame.contentDocument;
      if (doc) {
        var docElt = doc.documentElement;
        // TODO(ffu); expose scroll info from header-panel
        var pos = this.$.mainHeaderPanel.$.mainContainer.scrollTop;
        frame.style.height = 'auto';
        frame.style.height = docElt.scrollHeight + 'px';
        if (doc.body) {
          var s = doc.body.style;
          s.overflow = 'hidden';
          // to avoid the 'blinking bug'
          // https://code.google.com/p/chromium/issues/detail?id=332024
          s.webkitTransform = s.transform = 'translateZ(0)';
        }
        this.$.mainHeaderPanel.$.mainContainer.scrollTop = pos;
      }
    }
    
   });

</script>
</polymer-element>